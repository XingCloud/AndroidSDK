<?xml version="1.0"?>
<project name="XingCloudAndroid" default="main" basedir="../">

	<property name="javac.src" value="1.6"/>
	<property name="javadoc.path" value="${basedir}/doc"/>
	<property name="core.path" value="${basedir}/core_sdk" />
	<property name="core.src" value="${core.path}/src"/>
	<property name="core.classes" value="${core.path}/bin"/>
	<property name="generated.path" value="${basedir}/gen_code" />
	<property name="generated.itemspecmodeling.src" value="${generated.path}/itemspecmodeling/src"/>
	<property name="generated.itemmodeling.src" value="${generated.path}/itemmodeling/src"/>
	<property name="generated.itemspecmodeling.classes" value="${generated.path}/itemspecmodeling/bin"/>
	<property name="generated.itemmodeling.classes" value="${generated.path}/itemmodeling/bin"/>
	<property name="lib.dir" value="${core.path}/libs"/>
	<property name="depens.dir" value="${core.path}/depens"/>
	<property name="sdkversion" value="1.2.3.0" />
	<!-- <property name="sdk.jar" value="${basedir}/com.xingcloud.android-${sdkversion}.tag.jar"/> -->
	<property name="sdk.jar" value="${basedir}/xingcloudandroid.jar"/>
    <property name="key.file" value="${core.src}/com/xingcloud/core/SecurityKey.java" />
	<property name="build.number" value=""/>
	<property name="build.debug" value="true"/>
	<property name="skey" value="#secret_key#" />
	<property name="ckey" value="#consumer_key#" />

	<path id="classpath">
		<fileset dir="${depens.dir}" includes="**/*.jar"/>
		<fileset dir="${lib.dir}" includes="**/*.jar"/>
	</path>

	<target name="main" depends="pre_clean,updateKeys,make,javadoc,post_clean" description="cleans and runs the full build"/>

	<condition property="generated.itemspecmodeling.exist">
		<and>
			<available file="${generated.itemspecmodeling.src}" type="dir"/>
		</and>
	</condition>
	<condition property="generated.itemmodeling.exist">
		<and>
			<available file="${generated.itemmodeling.src}" type="dir"/>
		</and>
	</condition>
	<target name="prepare">
		<echo level="info">${ant.file}</echo>
		<mkdir dir="${core.classes}"/>
		<chmod file="${core.classes}" perm="ugo+rx" />
	</target>

	<target name="compile_core" depends="prepare" description="compile_core">
		<javac source="${javac.src}" target="${javac.src}" debug="${build.debug}" destdir="${core.classes}" srcdir="${core.src}"
            classpathref="classpath">
			<include name="**/*.java" />
			<exclude name="com/xingcloud/sfs/*.java" />
		</javac>
	</target>

	<target name="compile_gen_model" description="compile_gen_model" if="generated.itemmodeling.exist">
		<mkdir dir="${generated.itemmodeling.classes}"/>
		<chmod file="${generated.itemmodeling.classes}" perm="ugo+rx"/>
		<javac source="${javac.src}" target="${javac.src}" debug="${build.debug}" destdir="${generated.itemmodeling.classes}" srcdir="${generated.itemmodeling.src}"
            includes="**/*.java" classpathref="classpath" classpath="${core.classes}">
		</javac>
		<copy todir="${core.classes}">
			<fileset dir="${generated.itemmodeling.classes}"/>
		</copy>
	</target>
    
	<target name="compile_gen_specmodel" description="compile_gen_specmodel" if="generated.itemspecmodeling.exist">
		<mkdir dir="${generated.itemspecmodeling.classes}"/>
		<chmod file="${generated.itemspecmodeling.classes}" perm="ugo+rx"/>
		<javac source="${javac.src}" target="${javac.src}" debug="${build.debug}" destdir="${generated.itemspecmodeling.classes}" srcdir="${generated.itemspecmodeling.src}"
            includes="**/*.java" classpathref="classpath" classpath="${core.classes}">
		</javac>
		<copy todir="${core.classes}">
			<fileset dir="${generated.itemspecmodeling.classes}"/>
		</copy>
	</target>

	<target name="make" depends="compile_core,compile_gen_model,compile_gen_specmodel" description="compile and create compiler jars">
		<echo message="Building libs"/>
		<copy todir="${core.classes}" file="${core.path}/sdk-description.xml"/>
		<jar file="${sdk.jar}" basedir="${core.classes}"
            includes="com/xingcloud/**/*,model/**/*,sdk-description.xml">
            <archives>
                <zips>
                	<fileset dir="${lib.dir}" includes="**/*.jar"/>
                </zips>
            </archives>
            <manifest>
				<attribute name="Sealed" value="false"/>
				<attribute name="Implementation-Title" value="XingCloudAndroid"/>
				<attribute name="Implementation-Version" value="1.0.0.0"/>
				<attribute name="Implementation-Vendor" value="XingCloud"/>
			</manifest>
		</jar>
	</target>

    <property name="javadoc.sourcepath" value="${core.src}:${generated.itemmodeling.src}"/>

	<target name="javadoc">
		<javadoc access="public" author="false" classpath="${core.classes}" classpathref="classpath" destdir="${javadoc.path}" 
	            doctitle="Xingcloud Android SDK" nodeprecated="false" nodeprecatedlist="false" 
	            noindex="false" nonavbar="false" notree="false" packagenames="com.xingcloud.*,model.*" excludepackagenames="com.xingcloud.sfs.*"
	            source="1.6" sourcepath="${javadoc.sourcepath}" splitindex="true" use="true" version="true">
	    </javadoc>
	</target>

	<target name="pre_clean" description="pre_clean">
		<delete failonerror="false" file="${sdk.jar}"/>
		<delete failonerror="false" dir="${core.classes}"/>
		<delete failonerror="false" dir="${generated.itemspecmodeling.classes}"/>
		<delete failonerror="false" dir="${generated.itemmodeling.classes}"/>
	</target>

	<target name="post_clean" description="post_clean">
		<delete failonerror="false" dir="${core.classes}"/>
		<delete failonerror="false" dir="${generated.itemspecmodeling.classes}"/>
		<delete failonerror="false" dir="${generated.itemmodeling.classes}"/>
	</target>
	
	<target name="updateKeys" description="updateKeys">
		<replace file="${key.file}" token="#secret_key#" value="${skey}" summary="true"/>
        <replace file="${key.file}" token="#consumer_key#" value="${ckey}" summary="true"/>
	</target>
</project>
